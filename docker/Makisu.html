<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Makisu | Mind Manager</title>
    <meta name="description" content="Always Say,Never Work">
    
    <meta tag="docker"><meta tag="tools">
    <link rel="preload" href="/assets/css/0.styles.d52d262f.css" as="style"><link rel="preload" href="/assets/js/app.d00885a2.js" as="script"><link rel="preload" href="/assets/js/10.70986bac.js" as="script"><link rel="preload" href="/assets/js/8.5303c13b.js" as="script"><link rel="prefetch" href="/assets/js/11.b31b039c.js"><link rel="prefetch" href="/assets/js/12.cdb77f96.js"><link rel="prefetch" href="/assets/js/13.b969a3a8.js"><link rel="prefetch" href="/assets/js/2.54f75830.js"><link rel="prefetch" href="/assets/js/3.0cf58e18.js"><link rel="prefetch" href="/assets/js/4.830e3c93.js"><link rel="prefetch" href="/assets/js/5.9c3c05fa.js"><link rel="prefetch" href="/assets/js/6.1ed0196f.js"><link rel="prefetch" href="/assets/js/7.d649f13e.js"><link rel="prefetch" href="/assets/js/9.ad739853.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d52d262f.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Mind Manager</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/guide/guide.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://github.com/yqlwudi2012" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">Home</a></div><div class="nav-item"><a href="/guide/guide.html" class="nav-link">Guide</a></div><div class="nav-item"><a href="https://github.com/yqlwudi2012" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/guide/guide.html" class="sidebar-link">导航</a></li><li><a href="/docker/Makisu.html" class="active sidebar-link">Makisu</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docker/Makisu.html#来自布鲁塞尔最好的寿司" class="sidebar-link">来自布鲁塞尔最好的寿司</a></li><li class="sidebar-sub-header"><a href="/docker/Makisu.html#无特权构建" class="sidebar-link">无特权构建</a></li><li class="sidebar-sub-header"><a href="/docker/Makisu.html#分布式缓存设计" class="sidebar-link">分布式缓存设计</a></li><li class="sidebar-sub-header"><a href="/docker/Makisu.html#优化镜像大小" class="sidebar-link">优化镜像大小</a></li></ul></li></ul> </div> <div class="page"> <div class="content"><h1 id="makisu"><a href="#makisu" aria-hidden="true" class="header-anchor">#</a> Makisu</h1> <h2 id="来自布鲁塞尔最好的寿司"><a href="#来自布鲁塞尔最好的寿司" aria-hidden="true" class="header-anchor">#</a> 来自布鲁塞尔最好的寿司</h2> <p>尽管Uber已经退出了中国，但是这跟Uber的软件工程师是一群吃货没有半点关系。Makisu这个词在Google上通篇的搜索结果都是一家很有腔调的寿司店--当然，他们也许希望Docker构建的过程和寿司一样轻量，优雅而且美好。
Makisu的官方介绍是这样的:适用于Mesos和Kubernetes等无特权的集装箱化环境，快速灵活的Docker镜像构建工具。这个工具的诞生旨在解决Uber因为服务需求增长引起的大规模容器构建需求。传统的Docker构建工具，在面对上万次构建和单次构建工件超过10G的情况下开始显得无力，于是Makisu应运而生：</p> <ul><li>便携式和无权限构建设计。</li> <li>分布式缓存设计。</li> <li>镜像大小优化。</li></ul> <h2 id="无特权构建"><a href="#无特权构建" aria-hidden="true" class="header-anchor">#</a> 无特权构建</h2> <p>传统Docker的构建逻辑依赖于写时复制文件系统来确定构建时层之间的差异，并使用写时复制文件系统（CoW）生成图层，这一逻辑需要提升权限才能在构建容器中装入和卸载目录。</p> <div class="mermaid">
graph LR
A[Docker构建] -- 扫描 --&gt; B(中间层)
E[Makisu]--构建前扫描--&gt; C((内存))
C--构建后扫描--&gt;H(记录差异)
B --&gt;M(记录差异)
M--生成--&gt;D{新层}
H --生成--&gt; D
</div> <p>Makisu利用内存而非I\O复制来完成图层的创建，通过记录构造前后的文件差异在内存中直接生成新的镜像层。</p> <h2 id="分布式缓存设计"><a href="#分布式缓存设计" aria-hidden="true" class="header-anchor">#</a> 分布式缓存设计</h2> <p>传统的Docker build构建里，缓存的设计方式是由Docker引擎本身控制的，将缓存分层并用Hash序列的方式记录在本地注册表中。然而Docker引擎本身的层划分缺少复杂情况下的智能性--它会将大量构建依赖工具的安装和构建主要工件(通常而言，是代码工件)划分到一起，在工件执行新的commit之后整个hash码变化会使Docker无法复用原本的缓存，构建结构越复杂，缓存命中率越低。
同时，Docker的缓存都是在引擎机本地的，这意味着在分布式集群的Devops下，构建缓存面临着极低的利用率。
Makisu使用键值存储将给定Dockerfile的行映射到Docker注册表中层的摘要上。键值存储可以由Redis或文件系统支持。Makisu还强制执行缓存TTL，确保缓存条目不会变得太陈旧。在Dockerfile的初始构建期间，Makisu生成图层并异步推送到Docker注册表并进行键值存储。然后，共享相同构建步骤的后续构建可以获取和解压缩高速缓存的层，从而防止冗余步骤执行。
<div class="mermaid">
graph LR
A[Docker构建]  --&gt; B(缓存步骤A)
B--&gt;C((后续步骤))
B--&gt;D{Redis}
C--&gt;E(再次调用A)
D--缓存获取--&gt;E
</div></p> <h2 id="优化镜像大小"><a href="#优化镜像大小" aria-hidden="true" class="header-anchor">#</a> 优化镜像大小</h2> <p>为了控制在构建过程中生成的图像层，Makisu使用一个新的可选提交注释 <code>＃!COMMIT</code>， 它指定Dockerfile中的哪些行可以生成新层。这种机制允许减少容器图像大小（因为一些层可能删除或修改先前层添加的文件）。每个已提交的层也会上载到分布式缓存，这意味着它可以由群集中其他计算机上的构建使用。</p> <div class="mermaid">
graph LR
A[Docker构建]  --上传A--&gt; B{缓存A}
B--&gt;C(其他调用)
B--&gt;D(其他调用)
B--&gt;E(其他调用)
</div> <p>在Docker Mutli-stage形式的构建中，较大的镜像有时是由中间层创建和删除或更新文件的结果，即使在后续步骤中删除临时文件，它仍会保留在创建层中占用空间。</p> <div class="language- extra-class"><pre class="language-text"><code>FROM debian:8 AS build_phase
RUN apt-get install wget #!COMMIT
RUN apt-get install go1.10 #!COMMIT
COPY git-repo git-repo
RUN cd git-repo &amp;&amp; make

FROM debian:8 AS run_phase
RUN apt-get install wget #!COMMIT
LABEL service-name=test
COPY –from=build_phase git-repo/binary /binary
ENTRYPOINT /binary
</code></pre></div><p>看一个官方的Dockerfile例子。
在这种情况下，Mutli-stage构建会安装一些构建时需求（wget 和go1.10 ），在每个层中提交它们，然后继续构建服务代码。一旦构建了这些已提交的层，它们就会上载到分布式缓存并可供其他构建使用，从而提供显着的加速。
在第二阶段，构建再次安装wget ，但这次Makisu重用了构建阶段提交的层。最后，从构建阶段复制服务二进制文件，并生成最终镜像。这种方式生成了一个轻量的最终镜像，构建起来更快捷（由于分布式缓存的好处）并占用更少的空间，如下图所示：
<img src="https://img-blog.csdnimg.cn/20181210173342969.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTExNjYyMjU=,size_16,color_FFFFFF,t_70" alt="Makisu下的构建"></p></div> <div class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated: </span> <span class="time">12/14/2018, 1:41:10 PM</span></div></div> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/cssType/2018-12-13-滚动视差Made-In-CSS.html">
          滚动视差：Made In Css
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/app.d00885a2.js" defer></script><script src="/assets/js/10.70986bac.js" defer></script><script src="/assets/js/8.5303c13b.js" defer></script>
  </body>
</html>
